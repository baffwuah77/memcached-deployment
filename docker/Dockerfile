FROM memcached:1.6.23-alpine

# Runtime arguments from GitHub Secrets
ARG MEMCACHED_MAX_MEMORY=128
ARG MEMCACHED_MAX_CONNECTIONS=1024
ARG MEMCACHED_PORT=11211
ARG MEMCACHED_THREADS=4
ARG MEMCACHED_MAX_ITEM_SIZE=1m

# Convert to ENV vars
ENV MEMCACHED_MAX_MEMORY=${MEMCACHED_MAX_MEMORY} \
    MEMCACHED_MAX_CONNECTIONS=${MEMCACHED_MAX_CONNECTIONS} \
    MEMCACHED_PORT=${MEMCACHED_PORT} \
    MEMCACHED_THREADS=${MEMCACHED_THREADS} \
    MEMCACHED_MAX_ITEM_SIZE=${MEMCACHED_MAX_ITEM_SIZE}

# Expose port
EXPOSE ${MEMCACHED_PORT}

# Start with configuration from secrets
CMD memcached \
    -m ${MEMCACHED_MAX_MEMORY} \
    -c ${MEMCACHED_MAX_CONNECTIONS} \
    -p ${MEMCACHED_PORT} \
    -t ${MEMCACHED_THREADS} \
    -I ${MEMCACHED_MAX_ITEM_SIZE} \
    -u memcache \
    -v
